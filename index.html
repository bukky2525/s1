<!DOCTYPE html>
<html lang="en-us">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Unity WebGL Player | s1</title>
    <link rel="shortcut icon" href="TemplateData/favicon.ico">
    <link rel="manifest" href="manifest.webmanifest">
    <style>
      /* ページ全体のスタイル設定 */
      body {
        padding: 0;
        margin: 0;
        overflow: hidden;
        background: #231F20;
        width: 100vw;
        height: 100vh;
        font-family: Arial, sans-serif;
      }

      /* スタートオーバーレイ */
      #start-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.8);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 9999;
        color: white;
        text-align: center;
      }

      #start-button {
        padding: 20px 40px;
        font-size: 18px;
        background: #007acc;
        color: white;
        border: none;
        border-radius: 10px;
        cursor: pointer;
        transition: background 0.3s;
      }

      #start-button:hover {
        background: #005a9e;
      }

      /* 90度回転のスタイル */
      #unity-container {
        position: fixed !important;
        top: 50% !important;
        left: 50% !important;
        width: 100vh !important;
        height: 100vw !important;
        transform: translate(-50%, -50%) rotate(90deg) !important;
        transform-origin: center center !important;
        overflow: hidden !important;
        z-index: 1000 !important;
      }

      /* キャンバスのサイズ設定 */
      #unity-canvas {
        width: 100% !important;
        height: 100% !important;
        background: #231F20 !important;
        display: block !important;
        margin: 0 !important;
        padding: 0 !important;
      }

      /* ローディング要素のスタイル */
      #unity-loading-bar {
        position: absolute;
        left: 50%;
        top: 50%;
        transform: translate(-50%, -50%);
        display: none;
      }

      #unity-logo {
        width: 154px;
        height: 130px;
        background: url('TemplateData/unity-logo-dark.png') no-repeat center;
        background-size: contain;
      }

      #unity-progress-bar-empty {
        margin-left: auto;
        margin-right: auto;
        width: 141px;
        height: 18px;
        margin-top: 10px;
        background: url('TemplateData/progress-bar-empty-dark.png') no-repeat center;
        background-size: contain;
      }

      #unity-progress-bar-full {
        width: 0%;
        height: 18px;
        margin-top: 10px;
        background: url('TemplateData/progress-bar-full-dark.png') no-repeat center;
        background-size: contain;
      }

      #unity-warning {
        position: absolute;
        left: 50%;
        top: 5%;
        transform: translate(-50%);
        background: white;
        padding: 5px;
        color: black;
        border-radius: 5px;
      }

      /* 縦画面でのメッセージ表示 */
      @media (max-width: 768px) and (orientation: portrait) {
        #rotation-message {
          position: fixed;
          top: 50%;
          left: 50%;
          transform: translate(-50%, -50%);
          background: rgba(0, 0, 0, 0.9);
          color: white;
          padding: 20px;
          border-radius: 10px;
          text-align: center;
          z-index: 10000;
        }
      }
    </style>
  </head>
  <body>
    <!-- 音声開始用のオーバーレイ -->
    <div id="start-overlay">
      <div>
        <h2>ゲームを開始</h2>
        <p>タップして音声を有効にしてゲームを開始してください</p>
        <button id="start-button">ゲームスタート</button>
      </div>
    </div>

    <!-- 画面回転メッセージ -->
    <div id="rotation-message" style="display: none;">
      <h3>画面を横向きにしてください</h3>
      <p>最適なゲーム体験のために端末を横向きにしてください</p>
    </div>

    <div id="unity-container">
      <canvas id="unity-canvas" width=1280 height=720 tabindex="-1"></canvas>
      <div id="unity-loading-bar">
        <div id="unity-logo"></div>
        <div id="unity-progress-bar-empty">
          <div id="unity-progress-bar-full"></div>
        </div>
      </div>
      <div id="unity-warning"> </div>
    </div>

    <script>
      // グローバル変数
      var gameStarted = false;
      var audioContextResumed = false;

      // AudioContext の問題を解決する関数
      function resumeAudioContext() {
        if (audioContextResumed) return Promise.resolve();
        
        return new Promise((resolve) => {
          // AudioContext の再開を試行
          const tryResumeAudio = () => {
            try {
              // Web Audio API が利用可能かチェック
              if (window.AudioContext || window.webkitAudioContext) {
                const AudioContext = window.AudioContext || window.webkitAudioContext;
                if (window.unityAudioContext) {
                  // Unity の AudioContext を再開
                  if (window.unityAudioContext.state === 'suspended') {
                    window.unityAudioContext.resume().then(() => {
                      console.log('Unity AudioContext resumed successfully');
                      audioContextResumed = true;
                      resolve();
                    }).catch((error) => {
                      console.warn('Failed to resume Unity AudioContext:', error);
                      resolve(); // エラーでも続行
                    });
                  } else {
                    audioContextResumed = true;
                    resolve();
                  }
                } else {
                  // Unity の AudioContext がまだ作成されていない場合
                  audioContextResumed = true;
                  resolve();
                }
              } else {
                console.warn('AudioContext not supported');
                resolve();
              }
            } catch (error) {
              console.warn('Audio resume error:', error);
              resolve(); // エラーでも続行
            }
          };

          tryResumeAudio();
        });
      }

      // ゲーム開始処理
      function startGame() {
        if (gameStarted) return;

        console.log('Starting game...');
        gameStarted = true;

        // オーバーレイを隠す
        const overlay = document.getElementById('start-overlay');
        overlay.style.display = 'none';

        // AudioContext を再開
        resumeAudioContext().then(() => {
          console.log('Audio context ready');
          
          // Unity ゲームをロード
          loadUnityGame();
        });
      }

      // Unity ゲームのロード
      function loadUnityGame() {
        const container = document.querySelector("#unity-container");
        const canvas = document.querySelector("#unity-canvas");
        const loadingBar = document.querySelector("#unity-loading-bar");
        const progressBarFull = document.querySelector("#unity-progress-bar-full");
        const warningBanner = document.querySelector("#unity-warning");

        // ローディング表示
        loadingBar.style.display = "block";

        // Unity WebGL設定
        const buildUrl = "Build";
        const loaderUrl = buildUrl + "/WebGL_Build.loader.js";

        const config = {
          dataUrl: buildUrl + "/WebGL_Build.data",
          frameworkUrl: buildUrl + "/WebGL_Build.framework.js",
          codeUrl: buildUrl + "/WebGL_Build.wasm",
          streamingAssetsUrl: "StreamingAssets",
          companyName: "DefaultCompany",
          productName: "s1",
          productVersion: "1.0",
          showBanner: unityShowBanner,
          matchWebGLToCanvasSize: false,
          // 音声関連の設定
          autoSyncPersistentDataPath: false,
          // エラー処理の設定
          cacheControl: function(url) {
            return "must-revalidate";
          },
          // Unity WebGL の音声設定
          audioContext: {
            resume: true,
            autoplayPolicy: 'user-gesture-required'
          }
        };

        // Unity エンジンの初期化
        if (/iPhone|iPad|iPod|Android/i.test(navigator.userAgent)) {
          // モバイル デバイスの場合
          container.className = "unity-mobile";
        }

        loadingBar.style.display = "block";

        const script = document.createElement("script");
        script.src = loaderUrl;
        script.onload = () => {
          createUnityInstance(canvas, config, (progress) => {
            progressBarFull.style.width = 100 * progress + "%";
          }).then((unityInstance) => {
            loadingBar.style.display = "none";
            
            // AudioContext をUnity インスタンスに設定
            if (unityInstance.Module && unityInstance.Module.audioContext) {
              window.unityAudioContext = unityInstance.Module.audioContext;
              
              // AudioContext が suspended の場合は再開
              if (window.unityAudioContext.state === 'suspended') {
                window.unityAudioContext.resume().then(() => {
                  console.log('Unity AudioContext resumed after initialization');
                }).catch((error) => {
                  console.warn('Failed to resume AudioContext after initialization:', error);
                });
              }
            }
            
            console.log('Unity game loaded successfully');
          }).catch((message) => {
            alert(message);
          });
        };
        document.body.appendChild(script);
      }

      // バナー表示関数
      function unityShowBanner(msg, type) {
        const warningBanner = document.querySelector("#unity-warning");
        function updateBannerVisibility() {
          warningBanner.style.display = warningBanner.children.length ? 'block' : 'none';
        }
        var div = document.createElement('div');
        div.innerHTML = msg;
        warningBanner.appendChild(div);
        if (type == 'error') div.style = 'background: red; padding: 10px;';
        else if (type == 'warning') div.style = 'background: yellow; color: black; padding: 10px;';
        else div.style = 'background: blue; color: white; padding: 10px;';
        updateBannerVisibility();

        setTimeout(function() {
          warningBanner.removeChild(div);
          updateBannerVisibility();
        }, 5000);
      }

      // 画面の向きチェック
      function checkOrientation() {
        const rotationMessage = document.getElementById('rotation-message');
        if (window.innerHeight > window.innerWidth) {
          // 縦画面の場合
          rotationMessage.style.display = 'block';
        } else {
          // 横画面の場合
          rotationMessage.style.display = 'none';
        }
      }

      // イベントリスナーの設定
      document.addEventListener('DOMContentLoaded', function() {
        // スタートボタンのクリックイベント
        document.getElementById('start-button').addEventListener('click', startGame);

        // 画面回転の監視
        window.addEventListener('orientationchange', function() {
          setTimeout(checkOrientation, 100);
        });
        window.addEventListener('resize', checkOrientation);
        
        // 初期の向きチェック
        checkOrientation();

        // タッチイベントでもAudioContextを再開（追加保険）
        document.addEventListener('touchstart', function() {
          if (!audioContextResumed) {
            resumeAudioContext();
          }
        }, { once: true });

        // クリックイベントでもAudioContextを再開（追加保険）
        document.addEventListener('click', function() {
          if (!audioContextResumed) {
            resumeAudioContext();
          }
        }, { once: true });
      });

      // エラーハンドリング
      window.addEventListener('error', function(e) {
        if (e.filename && (e.filename.includes('blob:') || e.filename.includes('unity'))) {
          console.warn('Unity WebGL internal error (can be ignored):', e.message);
          e.preventDefault();
          return false;
        }
      });

      window.addEventListener('unhandledrejection', function(e) {
        if (e.reason && (e.reason.toString().includes('rmdir') || e.reason.toString().includes('AudioContext'))) {
          console.warn('Unity internal error (can be ignored):', e.reason);
          e.preventDefault();
          return false;
        }
      });

      // ServiceWorker の無効化（安定性のため）
      if ('serviceWorker' in navigator) {
        navigator.serviceWorker.getRegistrations().then(function(registrations) {
          registrations.forEach(function(registration) {
            registration.unregister();
          });
        });
      }

      console.log('Audio-enabled Unity WebGL Player initialized');
    </script>
  </body>
</html> 